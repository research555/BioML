Phylogeny-corrected identification of microbial gene families relevant to human gut colonization

The mechanisms by which different microbes colonize the healthy human gut versus other body sites, the gut in disease states, or other environments remain largely unknown. Identifying microbial genes influencing fitness in the gut could lead to new ways to engineer probiotics or disrupt pathogenesis. We approach this problem by measuring the statistical association between a species having a gene and the probability that the species is present in the gut microbiome. The challenge is that closely related species tend to be jointly present or absent in the microbiome and also share many genes, only a subset of which are involved in gut adaptation. We show that this phylogenetic correlation indeed leads to many false discoveries and propose phylogenetic linear regression as a powerful solution. To apply this method across the bacterial tree of life, where most species have not been experimentally phenotyped, we use metagenomes from hundreds of people to quantify each species’ prevalence in and specificity for the gut microbiome. This analysis reveals thousands of genes potentially involved in adaptation to the gut across species, including many novel candidates as well as processes known to contribute to fitness of gut bacteria, such as acid tolerance in Bacteroidetes and sporulation in Firmicutes. We also find microbial genes associated with a preference for the gut over other body sites, which are significantly enriched for genes linked to fitness in an in vivo competition experiment. Finally, we identify gene families associated with higher prevalence in patients with Crohn’s disease, including Proteobacterial genes involved in conjugation and fimbria regulation, processes previously linked to inflammation. These gene targets may represent new avenues for modulating host colonization and disease. Our strategy of combining metagenomics with phylogenetic modeling is general and can be used to identify genes associated with adaptation to any environment.

Why do certain microbes and not others colonize our gut, and why do they differ between healthy and sick people? One explanation is the genes in their genomes. If we can find microbial genes involved in gut adaptation, we may be able to keep out pathogens and encourage the growth of beneficial microbes. One could look for genes that were present more often in prevalent microbes, and less often in rare ones. However, this ignores that related species are more likely to share an environment and also share many unrelated phenotypes simply because of common ancestry. To solve this problem, we used a method from ecology that accounts for phylogenetic relatedness. We first calculated gut prevalence for thousands of species using a compendium of shotgun sequencing data, then tested for genes associated with prevalence, adjusting for phylogenetic relationships. We found genes that are associated with overall gut prevalence, with a preference for the gut over other body sites, and with the gut in Crohn’s disease versus health. Many of these findings have biological plausibility based on existing literature. We also showed agreement with the results of a previously published high-throughput screen of bacterial gene knockouts in mice. These results, and this type of analysis, may eventually lead to new strategies for maintaining gut health.

Microbes that colonize the human gastrointestinal (GI) tract have a wide variety of effects on their hosts, ranging from beneficial to harmful. Increasing evidence shows that commensal gut microbes are responsible for training and modulating the immune system [1, 2], protecting against inflammation [3] and pathogen invasion (reviewed in Sassone-Corsi and Raffatellu [4]), affecting GI motility [5], maintaining the intestinal barrier [6], and potentially even affecting mood [7]. In contrast, pathogens (and conditionally-pathogenic microbes, or “pathobionts”) can induce and worsen inflammation [8, 9], increase the risk of cancer in mouse models [10], and cause potentially life-threatening infections [11]. Additionally, the transplantation of microbes from a healthy host (fecal microbiota transplant, or FMT) is also a highly effective therapy for some gut infections [12], although it is still an active area of investigation why certain microbes from the donor persist long-term and others do not [13], and how pre-existing inflammatory disease affects FMT efficacy [14]. Which microbes are able to persist in the GI tract, and why some persist instead of others, is therefore a question with consequences that directly impact human health.

This approach to accounting for phylogenetic relationships is general and could be applied to measure association of any quantitative phenotype with genotypes or other binary or quantitative characteristics. In this study, we focus on phenotypes related to the ability of bacteria to colonize the human gut: 1. overall prevalence in the guts of hosts from a specific population (e.g., post-industrialized countries), which we expect to capture ease of transmission, how cosmopolitan microbes are, and how efficiently they colonize the gut; 2. a preference for the gut over other human body sites in the same hosts, which we expect to capture gut colonization more specifically; and 3. a preference for the gut in disease (e.g., Crohn’s disease) versus health. We present a novel analytic pipeline in which we estimate these quantitative phenotypes for thousands of bacterial species directly from existing shotgun metagenomics data, both obviating the need for us to draw a cutoff between “gut” and “non-gut” microbes, and also giving us the necessary power to detect associations (S2 Fig). Coupling these phenotype estimates with phylogenetic linear models, we generate a compendium of thousands of bacterial genes whose functions may be involved in colonizing the human gut.

We present a phylogeny-aware method for modeling associations between the presence of specific genes in bacterial genomes and quantitative phenotypes that measure how common these species are in the human microbiome. To apply phylogenetic linear modeling to the microbiome, we needed to solve three problems. First, we had to show that these models controlled false positives and had reasonable power on large bacterial phylogenies. Second, we needed to develop estimators that captured meaningful phenotypes related to bacterial colonization of humans for thousands of diverse bacterial species, most of which have never been studied in isolation, much less experimentally assayed for their abilities to colonize a mammalian body site. The third problem was to estimate genotypes (e.g., gene presence-absence) for each species. The analysis framework we describe is quite general and could be easily extended to link other phenotypes to genotypes across the tree of life.

To test for associations between quantitative phenotypes and binary genotypes across species, we use models with the following form:

These analyses showed that standard linear models result in many false positive associations. When the binary genotype was specified to be wholly uncorrelated (i.e., under the null), p-values from the linear model showed a strong anticonservative bias (Fig 1B and 1D) with many more significant p-values than expected under no correlation. While lower levels of phylogenetic signal (larger Ives-Garland α) did result in less bias in the standard linear model, the average false positive rate ranged between 20% and 68% at p = 0.05. In contrast, the phylogenetic linear model p-value distribution was flat and Type I error was controlled appropriately (Fig 1A and 1C). This means that at the same p-value threshold, linear models will identify many spurious relationships compared to phylogenetic linear models. Further, our simulations with non-zero associations showed that the phylogenetic model has high power when applied to gut bacterial phyla, even for small effect sizes (Fig 1E; see Methods, “Power-analysis”). These results emphasize the importance of using models that account for phylogenetic relationships in cross-species association testing and demonstrate the feasibility of applying phylogenetic linear models to the human microbiome.

To apply phylogenetic linear modeling to the microbiome we sought to define meaningful phenotypes for thousands of bacterial species, all of which have genome sequences but most of which have never been experimentally tested for, e.g., their abilities to grow on particular substrates or to colonize a model mammalian gut. We hypothesized that the prevalence and specificity of bacterial species in an environment, such as the human gut, should relate to their ability to colonize that environment and to how well adapted they are to persist there. These quantities can be thought of as phenotypes that can be estimated directly from shotgun metagenomics data. The precise taxonomic composition of a healthy gut microbiome can vary significantly from person to person [35], indicating that the ability of a microbe to colonize the gut is quantitative (and likely context-dependent, and stochastic). This phentoype can be conceptualized differently depending on which aspects of colonization one wishes to capture. We present metagenome-based estimators for two different types of colonization phenotpyes. These are described in the context of our goal of studying the gut microbiome, but the approach is general and could be used to quantify how well a given genotype discriminates species found in or specific to any environment.

The second type of environmental specificity we considered is the conditional probability that a host has a disease given that a particular species is present. This disease-specific specificity score is estimated in a similar way to the body-site specificity score (see Methods, “Estimating environmental specificity scores”). We focus on Crohn’s disease, a type of inflammatory bowel disease known to be associated with dramatic shifts in the gut microbiota and in gut-immune interactions [36]. Genes associated with this disease-specific prevalence could illuminate differences in selective pressures between healthy vs. diseased gut environments. Both scores are based on maximum a posteriori (MAP) estimates of the conditional probability of a sample being from the gut given that a microbe is observed in the sample. To account for sampling noise, we use a shrunken estimate with a Laplace prior (see Methods, “Estimating environmental specificity scores”).

We assembled a compendium of published DNA sequencing data from healthy human stool microbiomes across five studies in North America, Europe, and China (426 subjects total). Using the MIDAS database and pipeline [32], we mapped metagenomic sequencing reads from each run to a panel of phylogenetic marker genes, and from these, estimated the relative abundances of species. Multiple runs corresponding to the same individual were averaged. We then estimated the prevalence (probability of non-zero abundance) of each species across these subjects, weighting each study equally and adding pseudocounts to avoid probabilities of exactly 0 or 1 (see Methods, “Estimating the prevalence phenotype”). Finally, we determined whether genes (here, we take “genes” to mean members of a FIGfam protein family, which are designed to approximate “isofunctional homologs” [37]) were present or absent in the pangenomes of each species, based on sequenced genomes included in the MIDAS database, such that any FIGfam annotated in at least one sequenced isolate was considered to be present in the pangenome. This approach to genotyping could be extended to additionally include single-amplified genomes and metagenome-assembled genomes (see Discussion). Our analysis framework can also be applied to genotypes other than gene presence-absence (e.g., nucleotide or amino acid changes). We note that while the FIGfam database does include many hypothetical protein families of unknown function, many bacterial genes lack even this level of annotation, so a more comprehensive grouping of genes into orthologous or functionally homologous groups could reveal yet more novel associations.

These results suggest that standard linear models can identify genes that are truly important for colonizing an environment, such as the healthy human gut, but in addition will identify other genes that may simply be common in clades associated with that environment. The latter set will likely include many false positive associations from the perspective of understanding functions necessary for living in the environment. Phylogenetic linear models overcome this problem by adding the expectation that closely-related species will have similar phenotypes and distantly-related species will have less similar phenotypes, effectively upweighting instances where this is not the case. These conclusions are supported by our simulations and by an in vivo functional screen (see Results, “Deletion of gut-specific genes lowers fitness in the mouse microbiome”).

Several of the gene families that we observed to be associated with gut prevalence have previously been linked to gut colonization efficiency. For example, in Firmicutes, we noticed that several top hits were annotated as sporulation proteins (e.g., “Stage 0 sporulation two-component response regulator”, Fig 2C). Sporulation is known to be a strategy for surviving harsh environments (such as acid, alcohol, and oxygen exposure) that is used by many, but not all, members of Firmicutes. Resistance to oxygen (aerotolerance) is particularly important because many gut Firmicutes are strict anaerobes [39], sporulation is known to be an important mechanism of transmission and survival in the environment (reviewed in Swick et al. [40]), and sporulation ability has been linked to transmission patterns of gut microbes [32]. Our result associating sporulation proteins to gut prevalence provides further evidence for sporulation as a strategy that is generally important for the propagation and fitness of gut microbes.

In Bacteroidetes, we observed an association between gut prevalence and the presence of a pair of gene families putatively assigned to the GAD operon, namely, the glutamate decarboxylase gadB and the glutamate/gamma-aminobutyric acid (GABA) antiporter gadC. These genes show a complex pattern of presence that is strongly correlated with gut prevalence (Fig 2D, S5 Fig). Results from research in Proteobacteria, where these genes were first described, shows that their products participate in acid tolerance. L-glutamate must be protonated in order to be decarboxylated to GABA; export of GABA coupled to import of fresh L-glutamate therefore allows the net export of protons, raising intracellular pH [41]. It was previously hypothesized that this acid tolerance mechanism allowed bacteria to survive the harshly acidic conditions in the stomach: indeed, if disrupted in the pathogen Edwardsiella tarda, gut colonization in a fish model is impaired [42]. Listeria monocytogenes with disrupted GAD systems also become sensitive to porcine gastric fluid [43]. However, while it has previously been shown that gut Bacteroides do contain homologs for at least one of these genes [41], their functional importance has not yet been demonstrated in this phylum. Our results provide preliminary evidence that this system may be important in Bacteroidetes as well as in Proteobacteria.

The previous analyses have focused on modeling the phenotype of overall prevalence in the human gut. However, microbes could be prevalent in the gut for at least two main reasons. First, they could be specifically well-adapted to the human gut; second, they could simply be very common in the environment (i.e., highly dispersed). The presence or absence of a gene family could enhance either of these properties. Some genes might, for example, confer improved stress tolerance that was adaptive across a range of harsh conditions, while others might allow, for example, uptake and catabolism of metabolic substrates that were more common in the human gut than in other environments.

In Bacteroidetes, we found that a homolog of the autoinducer 2 aldolase lsrF was significant only in the body site-specific model. Autoinducer 2 is a small signaling molecule produced by a wide range of bacteria that is involved in interspecies quorum sensing. The protein lsrF, specifically, is part of an operon whose function in Escherichia coli is to “quench” or destroy the AI-2 signal [46]. Further, an increase of the AI-2 signal has been shown to decrease the Bacteroidetes/Firmicutes ratio in vivo in the intestines of streptomycin-treated mice [47]. Degrading this molecule is therefore a plausible gut-specific colonization strategy for gut Bacteroidetes. These discovered associations make the genes involved, including many genes without known functions or roles in gut biology, excellent candidates for understanding how bacteria adapt to the gut environment.

Beyond finding evidence for the plausibility of individual genes based on the literature, we were interested in whether more high-throughput experimental evidence supported the associations we found between gut colonization and gene presence. To interrogate this, we used results from an in vivo transposon-insertion screen of four strains of Bacteroides. This screen identified many genes whose disruption caused a competitive disadvantage in gnotobiotic mice, as revealed by time-course high-throughput sequencing; 79 gene families significantly affected microbial fitness across all four strains tested [48]. Determining agreement with this screen is somewhat complicated by the fact that we associated gene presence to gut specificity across all members of the phylum Bacteroidetes, and not only within the Bacteroides genus. Significance of overlap therefore depends on what we take as the null “background” set, the cutoff used for significance, and the set of results from the screen we choose as true positives (S3 Table).

Despite these complications, this analysis clearly showed that the 79 genes whose disruption led to lower fitness in the murine gut across all four Bacteroides species were over-represented among our predictions for gut-specific genes (odds ratio = 4.67, q = 6.7 × 10−3), and remained so if we only considered the gene families that were present in all Bacteroides species (odds ratio = 7.02, q = 3.4 × 10−3) (Table 1). Interestingly, we observed the opposite pattern for the overall prevalence model: the prevalence-associated genes we identified were actually depleted for genes found to be important in vivo (odds ratio = 0.18, q = 1.1 × 10−2). We believe that this is because the body-site-specific model, like the experiment, focused specifically on colonization efficiency, while the overall gut prevalence model would have included genes involved in persistence and dispersal in the environment and transfer between hosts. This experimental evidence supports the idea that environment-specific phylogenetic linear models truly identify genes that are important for bacteria to colonize an environment.

The above analyses were performed with respect to the gut of healthy individuals from the mainly post-industrial populations of North America, Europe and China. However, we also know that taxonomic shifts are common between healthy guts versus the guts of individuals from the same population with diseases such as type 2 diabetes, colorectal cancer, rheumatoid arthritis, and inflammatory bowel disease (reviewed in Wang et al. [49]). One explanation for these results is that sick hosts select for specific microbial taxa, as with the links previously observed between Proteobacteria and the inflammation that accompanies many disease states [50]. Since gut microbes have also been implicated in altering disease progression (reviewed in Lynch and Pedersen [51]), identifying genes associated with colonizing diseased individuals may afford us new opportunities for intervention.

An additional striking feature of the results was the number of Proteobacterial proteins associated with greater risk of Crohn’s that were annotated as being involved in type IV secretion and conjugative transfer systems (Fisher’s test q = 4.9 × 10−4). Conjugative transfer is a process by which gram-negative bacteria in direct physical contact share genetic material. More specifically, many of these genes, including one annotated as TraR (Fig 4), were homologs of those involved in an “F-type” conjugal system for transferring IncF plasmids, which can be classified as a variety of type IV secretion system [57]. Previously, in a mouse model, gut inflammation was shown to stimulate efficient horizontal gene transfer in Proteobacteria by promoting blooms of Enterobacteriaceae and thus facilitating cell-to-cell contact [58]. Future work will be required to determine whether this increased conjugation is a neutral consequence of inflammation, a causative factor, or provides a selective advantage in the inflamed gut.

The present analyses represent a first look into what can be learned by combining shotgun metagenomics with phylogenetically-aware models. Several extensions to our work could be made in the future. First, in addition to modeling prevalence, for instance, we could model abundance using a phylogenetic linear model with random effects [59], potentially allowing us to learn what controls the steady-state abundance of species in the gut. Additionally, we could also use these models to screen for epistatic interactions, which would be near-intractable even in systems with well-characterized genetic tools, but for which a subset of hypotheses could be validated by, e.g., comparing the fitness of wild-type microbes with double knockouts. While controlling the total number of tests would still be important to preserve power, an automated, computational approach to detecting gene interactions would still offer important savings in time and expense over developing a genome-wide experimental library of multiple knockouts per organism under investigation.

In summary, using phylogenetic linear models, we were able to discover thousands of specific gene families associated with quantitative phenotypes calculated directly from data: overall gut prevalence, a specificity score for the gut over other body sites, and a specificity score for the gut in Crohn’s disease versus health. Importantly, we have shown through simulation and real examples that standard linear models are inadequate for this task because of an unacceptably high false-positive rate under realistic conditions. Furthermore, many of the results we found also have biological plausibility, both from the literature on specific microbial pathways and from a high-throughput in vivo screen directly measuring colonization efficiency. In addition to these expected discoveries, we also found thousands of novel candidates for understanding and potentially manipulating gut colonization. These results illustrate the potential of integrating phylogeny with shotgun metagenomic data to deepen our understanding of the factors determining which microbes come to constitute our gut microbiota in health and disease.

A graphical overview of our statistical methods can be found in S2 Fig. Additionally, we provide a glossary of mathematical notation used in this section in S1 Appendix.

We utilized the previously published clustering of 31,007 high-quality bacterial genomes into 5,952 species from the MIDAS 1.0 database [32] (http://lighthouse.ucsf.edu/MIDAS/midas_db_v1.0.tar.gz). These species clusters are sets of genomes with high pairwise sequence similarity across a panel of 30 universal, single-copy genes. The genomes in each species clustering have approximately 95% average genome-wide nucleotide identity, a common “gold-standard” definition of bacterial and archaeal species [64]. These species-level taxonomic units are similar to, but can differ from, operational taxonomic units (OTUs) defined solely on the basis of the 16S rRNA gene.

Taxonomic annotations for each species were drawn from the MIDAS 1.0 database. Some taxonomic annotations of species in the MIDAS database were incomplete; these were fixed by searching the NCBI Taxonomy database using their web API via the rentrez package [65] and retrieving the full set of taxonomic annotations.

Pangenomes for all species used in this study were downloaded from the MIDAS 1.0 database. As previously described [32], pangenomes were constructed by clustering the DNA sequences of the genes found across all strains of each species at 95% sequence identity using UCLUST [66]. Pangenomes were functionally annotated based on the FIGfams [37] which were included in the MIDAS databases and originally obtained from the PATRIC [67] database. Thus, each pangenome represents the set of known, non-redundant genes from each bacterial species with at least one sequenced isolate.

The tree used for phylogenetic analyses was based on the tree from Nayfach et al. [32] based on an approximate maximum likelihood using FastTree 2 [68] on a concatenated alignment (using MUSCLE [69]) of thirty universal genes. Thus, each tip in the tree represents the phylogenetic placement for one bacterial species. For the current analyses, the tree was rooted using the cyanobacterium Prochlorococcus marinus as an outgroup, and the tree was then divided by phylum, retaining the four most prevalent phyla in the human gut (Bacteroidetes, Firmicutes, Actinobacteria, and Proteobacteria). One Actinobacterial species cluster, the radiation-resistant bacterium Kineococcus radiotolerans, was dropped from the tree because it had an extremely long branch length, indicating an unusual degree of divergence. Finally, phylum-specific trees were made ultrametric using the chronos function in the R package ape [70], assuming the default “correlated rates” model of substitution rate variation. We performed this step because first, our taxa were contemporaneously sampled, and second, we assumed that our phenotypes of interest varied with divergence time, as opposed to the number of substitutions per site separating marker gene sequences [71].

Metagenome samples were drawn from subjects in the Human Microbiome Project (HMP) [35], the MetaHIT consortium [52, 53], a study of glucose control [72], and a study of type 2 diabetes [73]. Accession numbers were identified using the aid of SRAdb [74] and downloaded from the Sequence Read Archive (SRA) [75]. The relative abundance of bacterial species in the metagenomes was estimated using MIDAS v1.0 [32], which maps reads to a panel of 15 phylogenetic marker genes. Species relative abundances are computed as previously described [32] (“Species abundance estimation”): essentially, they are normalized counts of reads mapping to bacterial species, with non-uniquely mapped reads assigned probabilistically.

Accession IDs used can be found in S4 Table. For prevalence estimates, we used healthy subjects from all four cohorts; for body site comparisons, we used only healthy subjects from HMP [35], and for the Crohn’s case-control comparison, we used only subjects from the MetaHIT consortium [52, 53].

The basic design is the same for all models that we fit: we model the effect of a categorical variable, gene (specifically, FIGfam family) presence vs. absence, on a particular phenotype estimated for many microbes from data.

The differences in the models we fit concern only how we obtain phenotype estimates
ϕ→x,E[,D](A)
, and our assumptions about how the residuals
ϵ→g
are distributed.

The phylogenetic and standard linear models are very similar, except for the assumptions about the distribution of the residuals. In the standard linear model, the residuals are assumed to be independently and identically distributed as a normal distribution, i.e., ϵg,m ∼ 𝒩(0, σ2) or using multivariate notation
ϵ→g∼N(0,σ2I)
. In the phylogenetic model, in contrast, the residuals are not independent: rather, they are correlated based on the phylogenetic relatedness of the species. They are therefore distributed ϵ ∼ 𝒩(0, Σ), with the following covariance matrix:

β1 parameters were tested for a significant difference from 0 and the resulting p-values were converted to q-values using Storey and Tibshirani’s FDR correction procedure [77, 78].

We use binary presence-absence data to calculate the phenotypes of interest. More formally, we conceptualize the metagenomic data as a matrix A of microbial presence-absence with dimensions i × j, where i is the number of microbes and j is the number of samples, and am,n is 1 if the relative abundance of microbe m (calculated using MIDAS’s taxonomic profiling [32]) is greater than 0, and 0 otherwise:

We conceptualize each e1, e2, …, ek ∈ E as a set of indices, referring to samples collected from that environment, e.g., the oropharynx in healthy subjects, or the gut in subjects with Crohn’s disease, such that for all ex ∈ E, ex ⊆ {1, 2, …, j}. Because one environment may be tested in multiple studies, for our prevalence estimates, we also define a similar mapping of samples to datasets d1, d2, …, dl ∈ D such that for all dy ∈ D, dy ⊆ {1, 2, …, j}. (For calculating environmental specificity scores, to avoid having to correct for unbalanced designs, we only use single datasets that measured all environments to be compared.) We also assume that E and D are partitions of {1, 2, …, j}, such that every sample is covered and no sample belongs to multiple ex or dy.

The first phenotype we consider is prevalence, p. Prevalence is usually defined as the fraction of samples in which a particular taxon is observed. Using the formulation above, the prevalence of microbe m in environment ex and study dy would be equal to:

To recapitulate, we use a logit-transformed, shrunken estimate of prevalence in a given environment, weighted so that each study contributes equally.

Prevalence gives us information about how commonly a microbe is seen in a particular environment. While useful, this concept does not address the difference between microbes that are specific for a given environment and those that have a cosmopolitan distribution. We therefore wanted to design a statistic capturing this environmental specificity. We define this statistic in terms of how predictive a particular microbe is for one out of a set of possible environments. (For simplicity, we only consider cases in which all environments were measured within a single study, and therefore drop D from these equations. This estimator could be extended in the future to account for study effects as above.)

Recall that prevalence can be defined as the probability P(m|ex), i.e., the probability of observing microbe m in environment ex. To avoid potential sources of confounding error, we only consider environments both measured within the same study. We therefore let the environmental specificity score sm,x,E equal the probability of observing a particular environment ex out of a set of k environments E = {e1, e2, …, ek}, given that we observe microbe m:

One simple way to estimate
s^m,x,E(A)
would be to simply plug in our estimates of
p^m,exADD(A)
, yielding:

To account for these issues, we construct a more aggressively-shrunk estimator of sm,x,E. We assume that most microbes do not differ substantially between environments, and therefore shrink estimates of sm,x,E = P(ex|m) towards the prior probability P(ex), indicating that that this microbe is uninformative about the environment. To accomplish this, we use a maximum a posteriori (MAP) estimator,
s^m,x,EMAP(A)
, with a Laplace prior centered on P(ex). Laplace priors are also used in the Bayesian lasso to make parameter estimates more sparse, by shrinking them to zero. However, critically, we are not using the Laplace prior to perform model selection, since the exact same model is fit as in Eq (1); we are only using it to reduce the variance in estimating
s^m,x,E
; unlike the Bayesian lasso, we therefore use no information about the independent variable (gene presence-absence) in obtaining estimates of
s^m,x,E
.

We are interested in estimating the specificity score sm,x,E of a microbe m in environment ex, given observations of microbial presence or absence am,n where n is a sample, a mapping of samples to environments E, and the prior probability P(ex) of choosing the environment ex ∈ E. In order to do this, we construct a model of the data that depends on sm,x,E, then maximize the posterior probability of observing the data given the model.

We can now expand this to give the final maximization:

We have assumed above that we are given the Laplace width parameter b. To choose appropriate, dataset-specific values of b, which controls how much
s^m,x,EMAP(A;b)
is shrunk back to the prior, we performed simulations. We chose a simulation-based approach instead of, for example, cross-validation because we lacked labeled examples of microbes that truly differed between environments. Instead, we constructed datasets A′ with elements
am,n′
where we “knew” that some microbes (m ∈ M0) were not informative about the environment and others (m ∉ M0) had “true” differences, by simulating data with the following model:

Given z = 2 and r = 0.5, for Crohn’s disease, boptim was estimated at b = 0.16 and for the body site specificity, boptim was estimated at b = 0.282. (Changing z to 1 or 0.5, or changing r to 0.1 or 0.9, resulted in very similar estimates of boptim. Additionally, boptim estimates were consistent across several orders of magnitude of ϵ; see S4 Fig).

An example showing the effect of this procedure on real data can be seen in S3 Fig. The microbe Bacillus subtilis is detected once in the healthy cohort and once in the Crohn’s cohort, while Bacteroides fragilis is present in 24/38 healthy subjects but 13/13 Crohn’s subjects (S3A Fig). The maximum-likelihood values of
p^m,CD,E(A)
and
s^m,CD,E(A)
are therefore much higher for B. subtilis than for B. fragilis, even though the evidence for a difference across environments in the prevalence of B. subtilis is much weaker (S3B and S3C Fig). In contrast, the Laplace prior (S3D Fig) successfully shrinks the estimate of the B. subtilis specificity score back to the baseline (P(eCD) = 0.002), while the evidence for B. fragilis overcomes this prior and yields an estimate close to the maximum-likelihood value (0.0031; S3E Fig).

An alternative to using the Laplace shrinkage estimator would be to allow all taxa to contribute to the regression, but to downweight taxa with less-confidently measured phenotypes. In generalized least squares (GLS), this is typically accomplished by scaling the variance-covariance matrix of the residuals by the variances of the estimators. This in effect says that the residuals are expected to be more dispersed around the regression line when the variance of the estimator is high: equivalently, this procedure weights each point in least-squares by the inverse of the estimator’s variance. We represent these variances as
vm≡(SE(s^m,x,E(A)))2
. The covariance matrix is then:

These results reflect the different underlying assumptions of each estimator: Laplace shrinkage assumes that taxa are not truly varying across environments without strong evidence, while WLS uses information from all taxa but downweights less-confidently-observed species. For the purposes of this manuscript, we focused on the results based on Laplace shrinkage estimation, since we believe the assumption that most taxa do not change is appropriate when comparing the same body site in health and disease. However, either approach may be preferable depending on the precise scenario being studied. It could also be possible to combine the two approaches by, for example, using the full posterior distribution of
s^m,x,E
to derive weights.

To test the power and false positive rate of our method, we used parametric simulations, either under the null hypothesis in which a gene had no effect on the phenotype, or under the alternative hypothesis in which it had a defined effect. These involved generating one binary genotype and one continuous phenotype per simulation. These were parameterized as follows:

The binary genotype effect size β1 is not a linear function of the effect of the gene on prevalence. A more intuitive description of the effect size might be the (average) fold-change in prevalence associated with a gene’s presence. Because the parameters βTest are on a logit scale, this quantity would be equal to:

One potential pitfall with applying linear methods occurs when the distribution of the response variable (here, our phenotype) has a minimum value. This arises because, within a particular dataset, the lowest possible value of
p^m,x,EADD(A)
is equal to (||ex|| + 2)−1, where ||ex|| is the number of samples in environment ex. This phenomenon is referred to as “left-censoring.” (Some may have encountered the term “left-censoring” in the context of participants who join a study having already experienced an event of interest. The time they experienced this event is therefore lower by an unknown amount than the lowest-possible measured value. While the domain and application are different, the statistical phenomenon is the same.) Left-censoring can result in inaccurate p-values because the variance is mis-estimated for the data points below the limit of detection. We therefore empirically assessed the impact of left-censoring in simulation, and also created extensions of the method to be used when its impact is noticeable.

Another common approach to this problem is the tobit model: the true value of the response variable is treated as a hidden variable, and expectation-maximization is used to fit the regression parameters based on the observed censored values. Given that the degree of censoring we observed did not appear to inflate the false positive rate in any of the methods we tested, we opted not to construct a phylogenetic tobit model; however, this could be an interesting area of future research.

Because relative abundances are compositional (i.e., sum to 1), changes in highly abundant taxa combined with read sampling can lead to skewed estimates of relative abundance. For example, if a very abundant microbe exhibits large changes in relative abundance across samples, other microbes will appear to become less abundant simply because they make up a smaller proportion of the total reads, regardless of whether their level has actually changed [82]. This necessitates the use of compositional data analysis methods such as fitting intrinsically compositional distributions to the data (e.g., multinomial [83]) or transforming them such that they no longer lie on a simplex (e.g., the clr-transform [84]). However, the impact of compositionality on prevalence was a priori less clear, because while prevalences are based on presence versus absence, which could be affected by sampling, prevalences themselves do not have to sum to any particular value. Nonetheless, since we compute prevalence from relative abundance, we undertook a simulation based investigation of prevalence estimation accuracy as a function of various study design and biological parameters.

To directly compare the degree to which spurious correlation in prevalence and relative abundance could be induced by compositionality, we simulated correlated absolute abundances of microbes with no true correlations between them, then converted these uncorrelated absolute abundances to relative abundances. To look for spurious correlation, we plotted the distribution of pairwise microbial correlations in absolute and relative abundances. We next used relative abundance to compute prevalence. Since there is only one prevalence measurement per microbe per data matrix, we repeated the simulation multiple times with the same parameters, then assessed microbial correlations across simulation runs, again starting from both absolute and relative abundances.

For each of 25 simulations i ∈ I, we assumed each of 1000 simulated microbes m ∈ M had absolute abundances
b(m,n)iAbs
, over a set of 100 simulated samples n ∈ N. These were independently log-normally distributed, centered on microbe-specific average values μm that were themselves log-normally distributed. We also assumed a microbe-specific prevalence zm drawn from a logistic-normal distribution:

We converted the resulting absolute abundance matrices
BiAbs
to relative abundances in two different ways. First, we simply column-normalized, yielding a matrix
BirelCN
with elements
b(m,n)irelCN=b(m,n)iAbs/∑m∈Mb(m,n)iAbs
. Second, we first generated compositional count data
BiCounts
, with column vectors
b→niCounts=[b1,niCounts,b2,niCounts,…,b‖M‖,niCounts]t
simulated as follows:

For each ||M|| × ||N|| matrix B, we obtained a set of correlations L(B) = {ρ(x,y)B:x, y ∈ M,  y < x}, where ρ(x,y)B is the Pearson correlation between the row-vectors
b→(x,n∈N)
and
b→(y,n∈N)
. L(A) can also be thought of as the entries in the lower-triangular part of the correlation matrix of a given B.

The correlation matrices of simulated absolute abundance data, as expected, are centered on zero. In contrast, the correlation matrix for the relative abundances
L(BirelCN)
is shifted markedly to the right (S9A Fig). While this seems to improve when plotting the results of the Dirichlet-Multinomial simulations,
L(BirelDM)
, when correlations are calculated over only non-zero elements, we see that they once again are shifted to the right by the same degree. These simulations show that relative abundance estimates are biased due to compositionality, consistent with previous work [85, 86], but that a high proportion of zeros (i.e., microbe not detected) can reduce this effect.

While relative abundance can be measured for each microbe in each sample, prevalence must be measured over a set of samples. To assess the impact of compositionality on prevalence, we therefore repeated the above simulation for 100 simulations i ∈ I, but this time held μm and zm constant across runs of the simulation to make them comparable.

In contrast to what we observed for relative abundance, the distributions of prevalences were almost identical when based on absolute abundances versus resampled relative abundances (S9B Fig). This strongly suggests that compositionality does not induce spurious correlations between taxon prevalences in the same way, or to the same degree, as it does for relative abundances.

Another source of error in prevalence estimates, which is related to our discussion of left-censoring, is the distinction between “structural” versus “sampling” zeros in relative abundance data [87]. Structural zeros arise from samples in which a microbe is really not present, whereas sampling zeros arise when a microbe is present but does not happen to be sampled. The fewer the number of samples, and the fewer reads per sample, the more likely sampling zeros are to occur.

Taken together, these simulations suggest that read depth, sample size, and true prevalence values affect the accuracy of prevalence estimates. Read depth becomes most important when most true prevalences are relatively large (5 − 95%). In contrast, when most prevalences are low, sample size is likely the most important consideration. Finally, when the sample size is sufficiently high (||N|| > 100) and most prevalences are low, microbes with prevalences above the limit of detection tend to be estimated accurately. These results provide guidelines for when the methods in this manuscript will be most accurate if applied to metagenomes from environments with different characteristics from human stool samples.

Enrichment analysis was performed using SEED subsystem annotations for FIGfams [88, 37]. Each subsystem was tested for a significant overlap with significant hits from the linear models (q ≤ 0.05), given the set of FIGfams tested, by Fisher’s exact test. For each gene set, a 2 × 2 contingency table was constructed with the following form:

Results of the screen were obtained from the Supplemental Material of Wu et al. (downloaded on 2017 May 3) [48]. Genes were mapped to FIGfams by matching identifiers in the Supplemental Material to genome annotations from PATRIC [67]. Significance of overlap between these genes and the results for the Bacteroidetes phylum from the body-site-specific or overall models was determined by Fisher’s exact test.

This test depends both on how we determine which genes from the in vivo screen count as true positives, and on the choice of the “background set,” i.e., which genes would be possible to find in the in vivo study. Rather than committing to one method of picking the “true positive” and “background” sets, we instead enumerated several possibilities, performed all possible combinations (S3 Table), and corrected for multiple comparisons. The options we tested for true positive sets were 1. genes in the screen that were significantly associated with fitness in all four Bacteroides strains tested, 2. Bacteroides thetaiotaomicron genes significantly associated with diet-independent fitness effects, and 3. B. thetaiotaomicron genes associated with either diet-dependent or -independent effects. The background sets we tested were 1. all gene families for which a phylogenetic model was fit, 2. all gene families appearing at least once in a Bacteroides genome cluster pangenome, 3. all gene families present in all Bacteroides pangenomes, 4. gene families present in some but not all Bacteroides pangenomes, and 5. gene families present in Bacteroides thetaiotaomicron. Similarly to our approach to gene set enrichment analysis, for each test we assembled a 2x2 contingency table as follows:

The analyses were carried out using R [91]. The code used to perform these analyses is available at http://www.bitbucket.com/pbradz/plr in the form of an Rmarkdown notebook [92].

Other R packages used include phylolm [76], phyloseq [93], rentrez [65], pbapply [94], XML [95], qvalue [77], magrittr [96], compiler [91], phytools [97], ggtree [98], gridExtra [99], MASS [100], nlme [80], fitdistrplus [81], truncnorm [101], ape [102], geiger [103], MCMCpack [104], knitr [105], data.table [106], parallel [91], and dplyr [107].

